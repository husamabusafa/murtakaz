generator client {
  provider = "prisma-client-js"
}

generator web_client {
  provider = "prisma-client-js"
  output   = "../web/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums

enum Role {
  SUPER_ADMIN
  ADMIN
  EXECUTIVE
  PMO
  MANAGER
  EMPLOYEE
}

enum Status {
  PLANNED
  ACTIVE
  AT_RISK
  COMPLETED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NodeTypeCode {
  STRATEGY
  PILLAR
  OBJECTIVE
  INITIATIVE
  PROJECT
  TASK
}

enum KpiPeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum KpiVariableDataType {
  NUMBER
  PERCENTAGE
}

enum KpiDefinitionStatus {
  ACTIVE
  INACTIVE
}

enum KpiValueStatus {
  DRAFT
  SUBMITTED
  APPROVED
  LOCKED
}

// Models

model Organization {
  id        String    @id @default(uuid())
  name      String
  domain    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  users          User[]
  nodes          Node[]
  kpis           KpiDefinition[]
  changeRequests ChangeRequest[]
}

model User {
  id            String       @id @default(uuid())
  orgId         String
  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  email         String
  emailVerified Boolean      @default(false)
  name          String
  role          Role
  department    String?
  image         String?
  password      String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  sessions    Session[]
  accounts    Account[]
  preferences UserPreference?

  approvals      ChangeApproval[]
  changeRequests ChangeRequest[]

  @@unique([orgId, email, deletedAt], name: "user_email_org_unique")
  @@index([orgId])
  @@map("user")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Session {
  id           String   @id @default(uuid())
  expiresAt    DateTime
  token        String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ipAddress    String?
  userAgent    String?
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model UserPreference {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  locale        String   @default("en")
  theme         String   @default("system")
  notifications Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ChangeRequest {
  id          String         @id @default(uuid())
  orgId       String
  org         Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  entityType  String
  entityId    String
  payload     Json
  status      ApprovalStatus @default(PENDING)
  requestedBy String
  requester   User           @relation(fields: [requestedBy], references: [id])
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  approvals ChangeApproval[]

  @@index([orgId])
}

model ChangeApproval {
  id              String         @id @default(uuid())
  changeRequestId String
  changeRequest   ChangeRequest  @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  approverId      String
  approver        User           @relation(fields: [approverId], references: [id])
  status          ApprovalStatus @default(PENDING)
  comment         String?
  createdAt       DateTime       @default(now())
  decidedAt       DateTime?

  @@unique([changeRequestId, approverId], name: "approval_once_per_user")
}

model NodeType {
  id          String       @id @default(uuid())
  code        NodeTypeCode @unique
  displayName String       @map("display_name")
  levelOrder  Int          @map("level_order")
  canHaveKpis Boolean      @default(false) @map("can_have_kpis")

  nodes Node[]

  @@map("node_types")
}

model Node {
  id         String  @id @default(uuid())
  companyId  String  @map("company_id")
  company    Organization @relation(fields: [companyId], references: [id], onDelete: Cascade)
  nodeTypeId String  @map("node_type_id")
  nodeType   NodeType @relation(fields: [nodeTypeId], references: [id], onDelete: Restrict)
  parentId   String? @map("parent_id")
  parent     Node?   @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Node[]  @relation("NodeHierarchy")
  name       String
  description String?
  ownerUserId String? @map("owner_user_id")
  ownerUser  User?   @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  status     Status  @default(PLANNED)
  startDate  DateTime? @map("start_date")
  endDate    DateTime? @map("end_date")
  createdAt  DateTime @default(now()) @map("created_at")

  kpis KpiDefinition[]

  @@index([companyId])
  @@index([nodeTypeId])
  @@index([parentId])
  @@index([ownerUserId])
  @@map("nodes")
}

model KpiDefinition {
  id            String              @id @default(uuid())
  companyId     String              @map("company_id")
  company       Organization        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  primaryNodeId String              @map("primary_node_id")
  primaryNode   Node                @relation(fields: [primaryNodeId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  formula       String?
  periodType    KpiPeriodType       @map("period_type")
  targetValue   Float?              @map("target_value")
  status        KpiDefinitionStatus @default(ACTIVE)

  variables KpiVariable[]
  values    KpiValuePeriod[]

  @@index([companyId])
  @@index([primaryNodeId])
  @@map("kpis")
}

model KpiVariable {
  id          String              @id @default(uuid())
  kpiId       String              @map("kpi_id")
  kpi         KpiDefinition       @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  code        String
  displayName String              @map("display_name")
  dataType    KpiVariableDataType @map("data_type")
  isRequired  Boolean             @default(false) @map("is_required")

  values KpiVariableValue[]

  @@unique([kpiId, code])
  @@index([kpiId])
  @@map("kpi_variables")
}

model KpiValuePeriod {
  id              String        @id @default(uuid())
  kpiId           String        @map("kpi_id")
  kpi             KpiDefinition @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  periodStart     DateTime      @map("period_start")
  periodEnd       DateTime      @map("period_end")
  calculatedValue Float?        @map("calculated_value")
  status          KpiValueStatus @default(DRAFT)
  enteredBy       String?       @map("entered_by")
  enteredByUser   User?         @relation("KpiValueEnteredBy", fields: [enteredBy], references: [id], onDelete: SetNull)
  approvedBy      String?       @map("approved_by")
  approvedByUser  User?         @relation("KpiValueApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)
  createdAt       DateTime      @default(now()) @map("created_at")

  variableValues KpiVariableValue[]

  @@unique([kpiId, periodStart, periodEnd])
  @@index([kpiId])
  @@index([enteredBy])
  @@index([approvedBy])
  @@map("kpi_values")
}

model KpiVariableValue {
  id            String         @id @default(uuid())
  kpiValueId    String         @map("kpi_value_id")
  kpiValue      KpiValuePeriod @relation(fields: [kpiValueId], references: [id], onDelete: Cascade)
  kpiVariableId String         @map("kpi_variable_id")
  kpiVariable   KpiVariable    @relation(fields: [kpiVariableId], references: [id], onDelete: Cascade)
  value         Float

  @@unique([kpiValueId, kpiVariableId])
  @@index([kpiValueId])
  @@index([kpiVariableId])
  @@map("kpi_variable_values")
}
