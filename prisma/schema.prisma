generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  EXECUTIVE
  PMO
  MANAGER
  EMPLOYEE
}

enum Status {
  PLANNED
  ACTIVE
  AT_RISK
  COMPLETED
}

enum MilestoneStatus {
  PLANNED
  IN_PROGRESS
  BLOCKED
  DONE
}

enum Health {
  GREEN
  AMBER
  RED
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TeamRole {
  OWNER
  CONTRIBUTOR
  REVIEWER
}

// Models
model Organization {
  id        String   @id @default(uuid())
  name      String
  domain    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  users          User[]
  pillars        Pillar[]
  goals          Goal[]
  initiatives    Initiative[]
  projects       Project[]
  kpis           KPI[]
  risks          Risk[]
  changeRequests ChangeRequest[]
}

model User {
  id         String   @id @default(uuid())
  orgId      String
  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  email      String
  name       String
  role       Role
  department String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?

  assignments TeamAssignment[]
  updates     Contribution[]
  approvals   ChangeApproval[]
  risksOwned  Risk[]
  kpiOwned    KPI[]    @relation("KPIOwner")
  kpiReviewed KPI[]    @relation("KPIReviewer")

  @@unique([orgId, email, deletedAt], name: "user_email_org_unique")
  @@index([orgId])
}

model Pillar {
  id          String   @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title       String
  description String?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  timeframe   String?
  status      Status   @default(PLANNED)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  initiatives Initiative[]
  goals       Goal[]

  @@index([orgId])
  @@index([ownerId])
}

model Goal {
  id          String   @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title       String
  description String?
  pillarId    String?
  pillar      Pillar?  @relation(fields: [pillarId], references: [id], onDelete: SetNull)
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  timeframe   String?
  status      Status   @default(PLANNED)
  health      Health?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  initiatives Initiative[]
  kpis        KPI[]

  @@index([orgId])
  @@index([pillarId])
  @@index([ownerId])
}

model Initiative {
  id             String   @id @default(uuid())
  orgId          String
  org            Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title          String
  description    String?
  goalId         String?
  goal           Goal?    @relation(fields: [goalId], references: [id], onDelete: SetNull)
  pillarId       String
  pillar         Pillar   @relation(fields: [pillarId], references: [id], onDelete: Cascade)
  ownerId        String
  owner          User     @relation(fields: [ownerId], references: [id])
  status         Status   @default(PLANNED)
  health         Health?
  healthScore    Float?
  healthUpdatedAt DateTime?
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?

  projects Project[]
  kpis     KPI[]
  risks    Risk[]
  updates  Contribution[]

  @@index([orgId])
  @@index([pillarId])
  @@index([goalId])
  @@index([ownerId])
}

model Project {
  id           String   @id @default(uuid())
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  ownerId      String
  owner        User     @relation(fields: [ownerId], references: [id])
  status       Status   @default(PLANNED)
  health       Health?
  healthScore  Float?
  startDate    DateTime?
  endDate      DateTime?
  dependencies String[]
  tags         String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  assignments TeamAssignment[]
  milestones  Milestone[]
  kpis        KPI[]
  updates     Contribution[]
  risks       Risk[]

  @@index([orgId])
  @@index([initiativeId])
  @@index([ownerId])
}

model Milestone {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title     String
  dueDate   DateTime?
  status    MilestoneStatus @default(PLANNED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamAssignment {
  id        String   @id @default(uuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      TeamRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId, role], name: "assignment_unique_per_role")
  @@index([orgId])
}

model KPI {
  id          String   @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name        String
  description String?
  formula     String?
  target      Float
  unit        String?
  frequency   String
  baseline    Float?
  dataSource  String?
  ownerId     String
  owner       User     @relation("KPIOwner", fields: [ownerId], references: [id])
  reviewerId  String?
  reviewer    User?    @relation("KPIReviewer", fields: [reviewerId], references: [id])
  goalId      String?
  goal        Goal?    @relation(fields: [goalId], references: [id], onDelete: SetNull)
  initiativeId String?
  initiative   Initiative? @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  measurements KPIValue[]
  changeLog    KPIChange[]

  @@index([orgId])
  @@index([initiativeId])
  @@index([projectId])
  @@index([goalId])
}

model KPIValue {
  id         String   @id @default(uuid())
  kpiId      String
  kpi        KPI      @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  measuredAt DateTime
  value      Float
  note       String?
  attachment String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([kpiId, measuredAt], name: "kpi_time_idx")
}

model KPIChange {
  id        String   @id @default(uuid())
  kpiId     String
  kpi       KPI      @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  changedBy String
  user      User     @relation(fields: [changedBy], references: [id])
  before    Json?
  after     Json?
  reason    String?
  createdAt DateTime @default(now())
}

model Contribution {
  id           String   @id @default(uuid())
  authorId     String
  author       User     @relation(fields: [authorId], references: [id])
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  initiativeId String?
  initiative   Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  progressPct  Float?
  summary      String
  blockers     String?
  risks        String?
  links        String[]
  createdAt    DateTime @default(now())

  @@index([projectId])
  @@index([initiativeId])
}

model Risk {
  id           String   @id @default(uuid())
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  severity     RiskSeverity
  status       Status   @default(ACTIVE)
  initiativeId String?
  initiative   Initiative? @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  ownerId      String
  owner        User     @relation(fields: [ownerId], references: [id])
  escalated    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  @@index([orgId])
  @@index([initiativeId])
  @@index([projectId])
}

model ChangeRequest {
  id          String   @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  entityType  String
  entityId    String
  payload     Json
  status      ApprovalStatus @default(PENDING)
  requestedBy String
  requester   User     @relation(fields: [requestedBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  approvals ChangeApproval[]

  @@index([orgId])
}

model ChangeApproval {
  id              String   @id @default(uuid())
  changeRequestId String
  changeRequest   ChangeRequest @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)
  approverId      String
  approver        User     @relation(fields: [approverId], references: [id])
  status          ApprovalStatus @default(PENDING)
  comment         String?
  createdAt       DateTime @default(now())
  decidedAt       DateTime?

  @@unique([changeRequestId, approverId], name: "approval_once_per_user")
}
