generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

generator web_client {
  provider = "prisma-client-js"
  output   = "../web/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums

enum Role {
  SUPER_ADMIN
  ADMIN
  EXECUTIVE
  MANAGER
}

enum KpiApprovalLevel {
  MANAGER
  EXECUTIVE
  ADMIN
}

enum Status {
  PLANNED
  ACTIVE
  AT_RISK
  COMPLETED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum KpiPeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum KpiVariableDataType {
  NUMBER
  PERCENTAGE
}

enum KpiValueStatus {
  DRAFT
  SUBMITTED
  APPROVED
  LOCKED
}

enum KpiDirection {
  INCREASE_IS_GOOD
  DECREASE_IS_GOOD
}

enum KpiAggregationMethod {
  LAST_VALUE
  SUM
  AVERAGE
  MIN
  MAX
}

enum KpiSourceType {
  MANUAL
  CALCULATED
  DERIVED
  SCORE
}

enum KpiApprovalType {
  AUTO
  MANUAL
}

// Models

model Organization {
  id        String    @id @default(uuid())
  name      String
  nameAr    String?   @map("name_ar")
  domain    String?
  kpiApprovalLevel KpiApprovalLevel @default(MANAGER) @map("kpi_approval_level")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  logoUrl   String?   @map("logo_url")
  mission   String?
  missionAr String?   @map("mission_ar")
  vision    String?
  visionAr  String?   @map("vision_ar")
  about     String?
  aboutAr   String?   @map("about_ar")
  contacts  Json?

  users          User[]
  entities       Entity[]
  entityTypes    OrgEntityType[]
  changeRequests ChangeRequest[]

  @@index([domain])
}

model OrgEntityType {
  id        String    @id @default(uuid())

  orgId     String    @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  code      String
  name      String
  nameAr    String?   @map("name_ar")
  sortOrder Int       @default(0) @map("sort_order")

  entities  Entity[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([orgId, code], name: "org_entity_type_code_unique")
  @@index([orgId])
  @@index([orgId, sortOrder])
  @@map("org_entity_types")
}

model User {
  id            String       @id @default(uuid())
  orgId         String       @map("org_id")
  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  email         String
  emailVerified Boolean      @default(false)
  name          String
  role          Role

  // Org hierarchy:
  managerId     String?      @map("manager_id")
  manager       User?        @relation("UserManager", fields: [managerId], references: [id], onDelete: SetNull)
  directReports User[]       @relation("UserManager")

  title         String?
  image         String?

  // If you support password auth, store hashedPassword (not plain password):
  hashedPassword String?     @map("hashed_password")

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  sessions    Session[]
  accounts    Account[]
  preferences UserPreference?

  approvals      ChangeApproval[]
  changeRequests ChangeRequest[]

  ownedEntities Entity[] @relation("EntityOwner")

  valuesEntered   EntityValuePeriod[] @relation("EntityValueEnteredBy")
  valuesSubmitted EntityValuePeriod[] @relation("EntityValueSubmittedBy")
  valuesApproved  EntityValuePeriod[] @relation("EntityValueApprovedBy")

  entityAssignments UserEntityAssignment[]

  @@unique([orgId, email], name: "user_email_org_unique")
  @@index([orgId])
  @@index([managerId])
  @@map("user")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Session {
  id           String   @id @default(uuid())
  expiresAt    DateTime
  token        String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ipAddress    String?
  userAgent    String?
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model UserPreference {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  locale        String   @default("en")
  theme         String   @default("system")
  notifications Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ChangeRequest {
  id          String         @id @default(uuid())
  orgId       String         @map("org_id")
  org         Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)

  entityType  String
  entityId    String
  payload     Json
  status      ApprovalStatus @default(PENDING)

  requestedBy String
  requester   User           @relation(fields: [requestedBy], references: [id], onDelete: Restrict)

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  decidedAt   DateTime?      @map("decided_at")
  deletedAt   DateTime?

  approvals ChangeApproval[]

  @@index([orgId])
  @@index([entityType, entityId])
}

model ChangeApproval {
  id              String         @id @default(uuid())
  changeRequestId String
  changeRequest   ChangeRequest  @relation(fields: [changeRequestId], references: [id], onDelete: Cascade)

  approverId      String
  approver        User           @relation(fields: [approverId], references: [id], onDelete: Restrict)

  status          ApprovalStatus @default(PENDING)
  comment         String?
  createdAt       DateTime       @default(now())
  decidedAt       DateTime?

  @@unique([changeRequestId, approverId], name: "approval_once_per_user")
  @@index([approverId])
}

model Entity {
  id        String       @id @default(uuid())

  orgId     String       @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  key       String?
  orgEntityTypeId String @map("org_entity_type_id")
  orgEntityType   OrgEntityType @relation(fields: [orgEntityTypeId], references: [id], onDelete: Restrict)

  title       String
  titleAr     String?   @map("title_ar")
  description String?
  descriptionAr String? @map("description_ar")

  ownerUserId String? @map("owner_user_id")
  ownerUser   User?   @relation("EntityOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  status    Status   @default(PLANNED)

  sourceType  KpiSourceType @default(MANUAL) @map("source_type")
  periodType  KpiPeriodType? @map("period_type")
  unit        String?
  unitAr      String? @map("unit_ar")

  direction   KpiDirection @default(INCREASE_IS_GOOD)
  aggregation KpiAggregationMethod @default(LAST_VALUE)

  baselineValue Float? @map("baseline_value")
  targetValue   Float? @map("target_value")
  weight        Float?

  formula String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  variables EntityVariable[]
  values    EntityValuePeriod[]
  assignments UserEntityAssignment[]

  @@index([orgId])
  @@index([orgEntityTypeId])
  @@index([ownerUserId])
  @@index([key])
  @@unique([orgId, key, deletedAt], name: "entity_key_org_soft_unique")
  @@map("entities")
}

model EntityVariable {
  id        String @id @default(uuid())

  entityId  String @map("entity_id")
  entity    Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  code        String
  displayName String @map("display_name")
  nameAr      String? @map("name_ar")

  dataType    KpiVariableDataType @map("data_type")

  isRequired  Boolean @default(false) @map("is_required")

  isStatic    Boolean @default(false) @map("is_static")
  staticValue Float?  @map("static_value")

  values EntityVariableValue[]

  @@unique([entityId, code], name: "entity_variable_unique")
  @@index([entityId])
  @@map("entity_variables")
}

model EntityValuePeriod {
  id        String @id @default(uuid())

  entityId  String @map("entity_id")
  entity    Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  actualValue Float? @map("actual_value")
  calculatedValue Float? @map("calculated_value")
  finalValue      Float? @map("final_value")
  achievementValue Float? @map("achievement_value")

  status       KpiValueStatus @default(DRAFT)
  approvalType KpiApprovalType? @map("approval_type")

  note String?

  enteredBy     String? @map("entered_by")
  enteredByUser User?   @relation("EntityValueEnteredBy", fields: [enteredBy], references: [id], onDelete: SetNull)

  submittedBy     String? @map("submitted_by")
  submittedByUser User?   @relation("EntityValueSubmittedBy", fields: [submittedBy], references: [id], onDelete: SetNull)

  approvedBy     String? @map("approved_by")
  approvedByUser User?   @relation("EntityValueApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)

  submittedAt DateTime? @map("submitted_at")
  approvedAt  DateTime? @map("approved_at")
  lockedAt    DateTime? @map("locked_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  variableValues EntityVariableValue[]

  @@unique([entityId, periodStart, periodEnd], name: "entity_period_unique")
  @@index([entityId])
  @@index([enteredBy])
  @@index([submittedBy])
  @@index([approvedBy])
  @@map("entity_values")
}

model EntityVariableValue {
  id            String @id @default(uuid())

  entityValueId String @map("entity_value_id")
  entityValue   EntityValuePeriod @relation(fields: [entityValueId], references: [id], onDelete: Cascade)

  entityVariableId String @map("entity_variable_id")
  entityVariable   EntityVariable @relation(fields: [entityVariableId], references: [id], onDelete: Cascade)

  value Float

  @@unique([entityValueId, entityVariableId], name: "entity_variable_value_unique")
  @@index([entityValueId])
  @@index([entityVariableId])
  @@map("entity_variable_values")
}

model UserEntityAssignment {
  id        String @id @default(uuid())

  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  entityId  String @map("entity_id")
  entity    Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  assignedBy     String? @map("assigned_by")
  assignedAt     DateTime @default(now()) @map("assigned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, entityId], name: "user_entity_assignment_unique")
  @@index([userId])
  @@index([entityId])
  @@index([assignedBy])
  @@map("user_entity_assignments")
}
